CREATE TABLE reservations
(
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  provider INTEGER NOT NULL CHECK (valid_provider(provider)),
  account_id BIGINT NOT NULL REFERENCES accounts(id),
  created_at TIMESTAMP NOT NULL DEFAULT current_timestamp,
  steps SMALLINT NOT NULL,
  step SMALLINT NOT NULL DEFAULT 0,
  status TEXT NOT NULL CHECK (NOT empty(status)),
  error TEXT NOT NULL DEFAULT '',
  finished_at TIMESTAMP,
  success BOOLEAN,

  UNIQUE (id, provider)
);

CREATE TABLE reservation_instances
(
  reservation_id BIGINT NOT NULL REFERENCES reservations(id) ON DELETE CASCADE,
  instance_id TEXT NOT NULL UNIQUE
);

CREATE TABLE aws_reservation_details
(
  reservation_id BIGINT NOT NULL,
  provider INTEGER NOT NULL DEFAULT provider_type_aws(),
  pubkey_id BIGINT NOT NULL REFERENCES pubkeys(id),
  source_id TEXT NOT NULL,
  image_id TEXT NOT NULL,
  aws_reservation_id TEXT,
  detail JSONB,

  FOREIGN KEY (reservation_id, provider) REFERENCES reservations(id, provider) ON DELETE CASCADE,
  CHECK (provider = provider_type_aws())
);
